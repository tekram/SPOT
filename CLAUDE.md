# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

SPOT (Scouting Platforms On Time) is an FRC scouting app framework by Team 3061. It provides configurable match scouting, data analysis, and admin tools — designed to work offline-first via Service Workers and client-side data processing. Preconfigured for the 2026 REBUILT game.

**Stack**: Node.js 16.x, Express, MongoDB/Mongoose, Socket.io, EJS, client-side vanilla JS. No frontend framework.

## Commands

```bash
npm install          # Install dependencies
npm start            # Start dev server (nodemon, port 8080)
```

No test framework is configured. No linter CLI — formatting is handled via VS Code Prettier on save (2-space indent).

## Architecture

### Entry Point & Routing

`src/app.js` — If `config/config.json` exists, mounts all feature routers. If not, redirects everything to the setup wizard.

### Feature Modules

Each feature under `src/` is self-contained with a consistent structure:

```
src/<feature>/
├── <feature>.js        # Express router
├── routes/api.js       # REST API endpoints
├── public/js/          # Client-side scripts
├── public/css/         # Styles
└── views/index.ejs     # Template
```

Modules: `scouting` (data collection), `analysis` (visualization), `admin` (live monitoring), `setup` (first-run wizard), `qrscanner`, `schedule`, `edit`, `checklist`.

### Database

`src/lib/db.js` — Two Mongoose models:
- **TeamMatchPerformance** — core scouting data: `robotNumber`, `matchNumber`, `eventNumber` (ObjectId ref to Event), `actionQueue` (array of `{id, ts, other}`)
- **Event** — `{code: String}` for event identification

### Configuration System (config/)

All customization is config-driven (no code changes needed for most use cases):

- **`config.json`** — Runtime secrets (DB URL, TBA key, Google Auth). Generated by setup wizard. Template at `config.template.json`.
- **`match-scouting.json`** — Scouting UI layout: grid dimensions, button definitions (id, gridArea, class, type, executables), timing/layer transitions for auto/teleop phases.
- **`analysis-pipeline.json`** — Chains of data transformers with type (tmp/team), outputPath, and options.
- **`analysis-modules.json`** — Which visualization modules to display, in which view (team/match) and position (main/side).
- **`analysis-transformers.json`** — Controls client-side transformer compilation (template file, type identifiers, ignore list).

### Client-Side Compilation (Key Pattern)

The analysis system compiles server-side code into client-side bundles at request time:

1. **Transformers** (`src/analysis/transformers/*.js`) — Each file contains `DataTransformer` objects wrapped in type markers (`__TMP__`/`__TEAM__`). `analysis.js` extracts these, injects them into a template (`_template.template.js`), and serves the result as `/analysis/transformers.js`.

2. **Modules** (`src/analysis/modules/*/index.js`) — All module `index.js` files are concatenated into `/analysis/modules.js`. Each module is a class with `constructor(config)`, `formatData(teams, dataset)`, and `setData(data)`.

3. **Executables** (`src/scouting/executables/*.js`) — Button action handlers compiled into `executables.js` for the scouting view.

### Real-Time Sync

`src/scouting/scouting-sync.js` — Socket.io handles live data sync between scouting clients and server. Supports offline queuing via Service Worker (`src/scouting/public/sw.js`).

### Shared Utilities

`src/lib/util.js` — `getPath(obj, path)` and `setPath(obj, path, value)` for dot-notation access on nested objects. Used extensively in transformers and the pipeline.

## Key Conventions

- **Transformer rules**: Do NOT put semicolons at the end of DataTransformer objects (breaks compilation). Only code within `__IDENTIFIER__`/`__/IDENTIFIER__` tags gets compiled. Variables outside the DataTransformer must go in the template file. Transformer `name` param must match the filename.
- **Game-agnostic naming**: Use "action", "count", "array" — not game-specific terms like "score" or "climb" — in transformers and modules.
- **Transformer types**: Either `tmp` (single team-match performance) or `team` (aggregated team data). A file can have both but NOT two of the same type.
- **Module structure**: Each module needs `index.js` (class) and `style.css` in `src/analysis/modules/<ModuleName>/`. Uses Plotly.js for charting.
- **Button executables**: Add new files to `src/scouting/executables/`. They're auto-compiled. Reference via `executables` array in `match-scouting.json`.
- **Config changes don't need server restart** for scouting layout; transformer/module changes do (recompiled on request but cached).

## First-Time Setup

The app auto-detects missing `config/config.json` and enters a setup wizard that walks through MongoDB connection, TBA API key, Google Auth, and event selection.
